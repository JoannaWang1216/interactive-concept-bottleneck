<!DOCTYPE html>
<html data-theme="light">
  <head>
    <title>Interactive Concept Bottleneck Model</title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.39.1/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div class="navbar bg-base-200">
      <p class="text-xl">Interactive Concept Bottleneck Model</p>
    </div>

    <div class="flex flex-col gap-2">
      <div id="image-icon" class="bg-gray-300 rounded-b-lg">
        <div class="w-1/3 m-auto">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
            <path
              style="fill: white"
              d="M528 64h-480C21.49 64 0 85.49 0 112v288C0 426.5 21.49 448 48 448h480c26.51 0 48-21.49 48-48v-288C576 85.49 554.5 64 528 64zM68 432L185.6 275.2c3.031-4.094 9.75-4.094 12.78 0l39.6 52.8L159.1 432H68zM180 432l165.6-220.8c3.031-4.094 9.75-4.094 12.78 0L524 432H180zM560 400c0 12.75-7.627 23.59-18.45 28.73L371.2 201.6c-9.125-12.22-29.28-12.22-38.41 0L247.1 314.7L211.2 265.6c-9.125-12.22-29.28-12.22-38.41 0L47.1 432C30.36 432 16 417.6 16 400v-288c0-17.64 14.36-32 32-32h480c17.64 0 32 14.36 32 32V400zM128 144C101.5 144 80 165.5 80 192S101.5 240 128 240S176 218.5 176 192S154.5 144 128 144zM128 224C110.4 224 96 209.6 96 192s14.36-32 32-32s32 14.36 32 32S145.6 224 128 224z"
            />
          </svg>
        </div>
      </div>

      <div id="uploaded-image-container" class="hidden p-2">
        <figure class="shadow-xl w-fit my-5 mx-auto rounded-lg overflow-hidden">
          <img id="uploaded-image" />
        </figure>
      </div>

      <div class="flex gap-2 m-2">
        <button class="btn flex-1" id="upload-button">Upload Image</button>
        <input
          type="file"
          id="file-input"
          class="hidden"
          accept=".jpg, .jpeg, .png"
        />
        <button class="btn flex-1 btn-disabled" id="predict-button">
          Predict
        </button>
      </div>

      <div class="flex gap-2 p-2">
        <div class="flex flex-col flex-1 gap-1 items-center">
          <p class="text-lg hidden" id="recognized-concepts-table-title">
            Recognized Concepts
          </p>
          <div
            class="w-full shadow-xl rounded-lg overflow-hidden hidden"
            id="recognized-concepts-table"
          >
            <table class="table text-center w-full table-fixed">
              <thead>
                <tr>
                  <th>Concepts</th>
                  <th>Probability</th>
                </tr>
              </thead>
              <tbody id="concepts-table-body"></tbody>
            </table>

            <div class="flex w-full">
              <button class="btn btn-xs btn-ghost rounded-none">«</button>
              <button
                class="btn btn-xs btn-ghost flex-1 rounded-none no-animation"
                id="concepts-table-page-button"
              ></button>
              <button class="btn btn-xs btn-ghost rounded-none">»</button>
            </div>
          </div>
        </div>

        <div class="flex flex-col flex-1 gap-1 items-center">
          <p class="text-lg hidden" id="final-prediction-table-title">
            Final Prediction
          </p>
          <div
            class="w-full shadow-xl rounded-lg overflow-hidden hidden"
            id="final-prediction-table"
          >
            <table class="table text-center w-full">
              <thead>
                <tr>
                  <th>Species</th>
                  <th>Probability</th>
                </tr>
              </thead>
              <tbody id="final-prediction-table-body"></tbody>
            </table>

            <div class="flex w-full">
              <button class="btn btn-xs btn-ghost rounded-none">«</button>
              <button
                class="btn btn-xs btn-ghost flex-1 rounded-none no-animation"
                id="final-prediction-table-page-button"
              ></button>
              <button class="btn btn-xs btn-ghost rounded-none">»</button>
            </div>
          </div>
        </div>
      </div>

      <button class="btn m-2 btn-disabled hidden" id="rerun-button">
        Rerun
      </button>
    </div>
    <script>
      const disableInputs = () => {
        uploadButton.classList.add("btn-disabled");
        predictButton.classList.add("btn-disabled");
        rerunButton.classList.add("btn-disabled");
        // document.getElementById("recognized-concepts-table").innerHTML =
        //   '<div class="lds-dual-ring"></div>';
        // document.getElementById("final-prediction-table").innerHTML =
        //   '<div class="lds-dual-ring"></div>';
      };

      const enableInputs = () => {
        uploadButton.classList.remove("btn-disabled");
        predictButton.classList.remove("btn-disabled");
        rerunButton.classList.remove("btn-disabled");
      };

      const predict = async () => {
        if (!uploadedImageData) {
          console.error("No image uploaded");
          return;
        }
        disableInputs();
        const formData = new FormData();
        formData.append("image", uploadedImageData);

        return fetch("http://127.0.0.1:5000/predict", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .catch((error) => {
            console.error(error);
            return {
              recognized_concepts: {},
              final_prediction: {},
            };
          });
      };

      const render = (data) => {
        console.log(data);
        enableInputs();

        const conceptsItems = Object.entries(data.recognized_concepts);
        conceptsItems.sort((a, b) => b[1] - a[1]);
        let pagedConceptsItems = [];
        for (let i = 0; i < conceptsItems.length; i++) {
          if (i % 8 === 0) {
            pagedConceptsItems.push([]);
          }
          pagedConceptsItems[pagedConceptsItems.length - 1].push(
            conceptsItems[i]
          );
        }

        const conceptsTableBody = document.getElementById(
          "concepts-table-body"
        );
        conceptsTableBody.innerHTML = ``;
        pagedConceptsItems[conceptsTablePageNumber - 1].forEach(
          (conceptItem) => {
            conceptsTableBody.innerHTML += `
              <tr>
                <td class="overflow-hidden text-ellipsis">${conceptItem[0]}</td>
                <td class="overflow-hidden text-ellipsis">
                  <input
                    type="number"
                    min="0"
                    max="1"
                    step="0.0001"
                    placeholder="Probability"
                    value="${conceptItem[1].toFixed(4)}"
                    class="input input-xs w-full max-w-xs text-center text-base"
                  />
                </td>
              </tr>
            `;
          }
        );
        document.getElementById("concepts-table-page-button").innerHTML =
          conceptsTablePageNumber + "/" + pagedConceptsItems.length;
        document
          .getElementById("recognized-concepts-table-title")
          .classList.remove("hidden");
        document
          .getElementById("recognized-concepts-table")
          .classList.remove("hidden");

        const classItems = Object.entries(data.final_prediction);
        classItems.sort((a, b) => b[1] - a[1]);
        let pagedClassItems = [];
        for (let i = 0; i < classItems.length; i++) {
          if (i % 8 === 0) {
            pagedClassItems.push([]);
          }
          pagedClassItems[pagedClassItems.length - 1].push(classItems[i]);
        }

        const finalPredictionTableBody = document.getElementById(
          "final-prediction-table-body"
        );
        finalPredictionTableBody.innerHTML = ``;
        pagedClassItems[finalPredictionTablePageNumber - 1].forEach(
          (classItem) => {
            finalPredictionTableBody.innerHTML += `
              <tr>
                <td class="overflow-hidden text-ellipsis">${classItem[0]}</td>
                <td class="overflow-hidden text-ellipsis">
                  ${classItem[1].toFixed(4)}
                </td>
              </tr>
            `;
          }
        );
        document.getElementById(
          "final-prediction-table-page-button"
        ).innerHTML =
          finalPredictionTablePageNumber + "/" + pagedClassItems.length;
        document
          .getElementById("final-prediction-table-title")
          .classList.remove("hidden");
        document
          .getElementById("final-prediction-table")
          .classList.remove("hidden");

        rerunButton.classList.remove("hidden");
      };

      const uploadImage = (event) => {
        console.log(event);
        uploadedImageData = event.target.files[0];
        uploadedImage.src = URL.createObjectURL(event.target.files[0]);
        document
          .getElementById("uploaded-image-container")
          .classList.remove("hidden");
        document.getElementById("image-icon").classList.add("hidden");
        predictButton.classList.remove("btn-disabled");
      };

      let uploadedImageData = undefined;

      const fileInput = document.getElementById("file-input");
      fileInput.addEventListener("change", uploadImage);

      const uploadButton = document.getElementById("upload-button");
      uploadButton.addEventListener("click", () => fileInput.click());

      const uploadedImage = document.getElementById("uploaded-image");

      const predictButton = document.getElementById("predict-button");
      predictButton.addEventListener("click", () => predict().then(render));

      const rerunButton = document.getElementById("rerun-button");

      const conceptsTablePageNumber = 1;
      const finalPredictionTablePageNumber = 1;
    </script>
  </body>
</html>
